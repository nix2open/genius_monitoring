name: Latency Monitor

on:
  schedule:
    - cron: '*/30 * * * *'  # –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Measure latency 3 times
        id: latency
        env:
          URL: 'https://ad.new-programmatic.com/services/nslookup?require-debug-info=body&tid=3835&debug.ccg=235034&debug.ip=79.139.162.4'
        run: |
          echo "Measuring latency and status for $URL (3 attempts, timeout 15s each)"

          measure_once() {
            local out
            # time_total –∏ http_code –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ, —Ç–∞–π–º–∞—É—Ç 15 —Å–µ–∫—É–Ω–¥
            out=$(curl -s -o /dev/null --max-time 15 -w "%{time_total} %{http_code}" "$URL" 2>/dev/null || echo "15.000 000")
            echo "$out"
          }

          read T1 C1 <<<"$(measure_once)"
          LAT1=$(echo "$T1" | awk '{print int($1*1000)}')
          echo "Try #1: ${LAT1} ms, code ${C1}"

          read T2 C2 <<<"$(measure_once)"
          LAT2=$(echo "$T2" | awk '{print int($1*1000)}')
          echo "Try #2: ${LAT2} ms, code ${C2}"

          read T3 C3 <<<"$(measure_once)"
          LAT3=$(echo "$T3" | awk '{print int($1*1000)}')
          echo "Try #3: ${LAT3} ms, code ${C3}"

          SUM=$((LAT1 + LAT2 + LAT3))
          AVG_MS=$((SUM / 3))

          echo "Average latency: ${AVG_MS} ms"

          {
            echo "lat1=${LAT1}"
            echo "lat2=${LAT2}"
            echo "lat3=${LAT3}"
            echo "code1=${C1}"
            echo "code2=${C2}"
            echo "code3=${C3}"
            echo "avg_ms=${AVG_MS}"
          } >> "$GITHUB_OUTPUT"

      # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–ª–µ—Ä—Ç, –µ—Å–ª–∏:
      # - avg_ms > 10000 –ò–õ–ò
      # - –≤—Å–µ —Ç—Ä–∏ –∫–æ–¥–∞ >= 500
      - name: Check and maybe send Telegram alert
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          URL: 'https://ad.new-programmatic.com/services/nslookup?require-debug-info=body&tid=3835&debug.ccg=235034&debug.ip=79.139.162.4'
        run: |
          LAT1=${{ steps.latency.outputs.lat1 }}
          LAT2=${{ steps.latency.outputs.lat2 }}
          LAT3=${{ steps.latency.outputs.lat3 }}
          AVG=${{ steps.latency.outputs.avg_ms }}
          CODE1=${{ steps.latency.outputs.code1 }}
          CODE2=${{ steps.latency.outputs.code2 }}
          CODE3=${{ steps.latency.outputs.code3 }}

          echo "Checking conditions..."
          echo "avg_ms=${AVG}, codes=${CODE1},${CODE2},${CODE3}"

          ALERT_REASON=""

          # –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è > 10 —Å–µ–∫—É–Ω–¥
          if [ "$AVG" -gt 10000 ]; then
            ALERT_REASON="–í—ã—Å–æ–∫–æ–µ —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (>10s)."
          fi

          # –í—Å–µ —Ç—Ä–∏ –∫–æ–¥–∞ 5xx
          if [ "$CODE1" -ge 500 ] && [ "$CODE2" -ge 500 ] && [ "$CODE3" -ge 500 ]; then
            if [ -n "$ALERT_REASON" ]; then
              ALERT_REASON="${ALERT_REASON} –°–µ—Ä–≤–∏—Å –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫—É (HTTP 5xx)."
            else
              ALERT_REASON="–°–µ—Ä–≤–∏—Å –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫—É (HTTP 5xx)."
            fi
          fi

          if [ -z "$ALERT_REASON" ]; then
            echo "‚úÖ OK, no alert."
            exit 0
          fi

          echo "Sending Telegram alert: $ALERT_REASON"

          MSG="üö® Alert!
URL: ${URL}
–ü—Ä–∏—á–∏–Ω–∞: ${ALERT_REASON}
–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${AVG} ms
–ó–∞–º–µ—Ä—ã:
1) ${LAT1} ms, –∫–æ–¥ ${CODE1}
2) ${LAT2} ms, –∫–æ–¥ ${CODE2}
3) ${LAT3} ms, –∫–æ–¥ ${CODE3}
"

          MSG_ESCAPED=$(printf '%s' "$MSG" | python -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": ${MSG_ESCAPED}}"
