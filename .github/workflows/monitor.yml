name: Latency Monitor

on:
  schedule:
    - cron: '*/30 * * * *'  # ÐºÐ°Ð¶Ð´Ñ‹Ðµ 30 Ð¼Ð¸Ð½ÑƒÑ‚
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Measure latency 3 times
        id: latency
        env:
          URL: 'https://ad.new-programmatic.com/services/nslookup?require-debug-info=body&tid=3835&debug.ccg=235034&debug.ip=79.139.162.4'
        run: |
          echo "Measuring latency for $URL (3 attempts, timeout 15s each)"

          measure_once() {
            local t
            # --max-time 15: Ð¾Ð±Ñ‰Ð¸Ð¹ Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ 15 ÑÐµÐºÑƒÐ½Ð´ Ð½Ð° Ð·Ð°Ð¿Ñ€Ð¾Ñ [web:114][web:120]
            t=$(curl -o /dev/null -s -w "%{time_total}" --max-time 15 "$URL" 2>/dev/null || echo "15.000")
            # Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð¸Ð¼ Ð² Ð¼Ð¸Ð»Ð»Ð¸ÑÐµÐºÑƒÐ½Ð´Ñ‹ Ð¸ Ð¾ÐºÑ€ÑƒÐ³Ð»ÑÐµÐ¼ Ð²Ð½Ð¸Ð· Ð´Ð¾ int
            echo "$t" | awk '{print int($1*1000)}'
          }

          LAT1=$(measure_once)
          echo "Latency #1: ${LAT1} ms"
          LAT2=$(measure_once)
          echo "Latency #2: ${LAT2} ms"
          LAT3=$(measure_once)
          echo "Latency #3: ${LAT3} ms"

          SUM=$((LAT1 + LAT2 + LAT3))
          AVG_MS=$((SUM / 3))  # ÑÑ€ÐµÐ´Ð½ÐµÐµ Ð¸Ð· Ñ‚Ñ€Ñ‘Ñ… Ð·Ð°Ð¼ÐµÑ€Ð¾Ð² [web:119][web:129]

          echo "Average latency: ${AVG_MS} ms"

          {
            echo "lat1=${LAT1}"
            echo "lat2=${LAT2}"
            echo "lat3=${LAT3}"
            echo "avg_ms=${AVG_MS}"
          } >> "$GITHUB_OUTPUT"

      - name: Send Telegram alert
        # 10 ÑÐµÐºÑƒÐ½Ð´ = 10000 Ð¼Ñ
        if: ${{ fromJSON(steps.latency.outputs.avg_ms) > 10000 }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          URL: 'https://ad.new-programmatic.com/services/nslookup?require-debug-info=body&tid=3835&debug.ccg=235034&debug.ip=79.139.162.4'
        run: |
          LAT1=${{ steps.latency.outputs.lat1 }}
          LAT2=${{ steps.latency.outputs.lat2 }}
          LAT3=${{ steps.latency.outputs.lat3 }}
          AVG=${{ steps.latency.outputs.avg_ms }}

          echo "Average too high (${AVG} ms), sending Telegram alert"

          TEXT="ðŸš¨ Latency Alert!
URL: ${URL}
Ð¡Ñ€ÐµÐ´Ð½ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð°: ${AVG} ms (> 10000 ms)
Ð—Ð°Ð¼ÐµÑ€Ñ‹:
1) ${LAT1} ms
2) ${LAT2} ms
3) ${LAT3} ms"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"text\": \"${TEXT}\"
            }"

      - name: Log OK
        if: ${{ fromJSON(steps.latency.outputs.avg_ms) <= 10000 }}
        run: |
          echo "âœ… Average latency OK: ${{ steps.latency.outputs.avg_ms }} ms"
          echo "Values: ${{ steps.latency.outputs.lat1 }} ms, ${{ steps.latency.outputs.lat2 }} ms, ${{ steps.latency.outputs.lat3 }} ms"
