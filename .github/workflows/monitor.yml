name: Latency Monitor

on:
  schedule:
    - cron: '*/30 * * * *'  # –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Measure latency 3 times
        id: latency
        env:
          URL: 'https://ad.new-programmatic.com/services/nslookup?require-debug-info=body&tid=3835&debug.ccg=235034&debug.ip=79.139.162.4'
        run: |
          echo "Measuring latency for $URL (3 attempts, timeout 15s each)"

          measure_once() {
            local t
            t=$(curl -o /dev/null -s -w "%{time_total}" --max-time 15 "$URL" 2>/dev/null || echo "15.000")
            echo "$t" | awk '{print int($1*1000)}'
          }

          LAT1=$(measure_once)
          echo "Latency #1: ${LAT1} ms"
          LAT2=$(measure_once)
          echo "Latency #2: ${LAT2} ms"
          LAT3=$(measure_once)
          echo "Latency #3: ${LAT3} ms"

          SUM=$((LAT1 + LAT2 + LAT3))
          AVG_MS=$((SUM / 3))

          echo "Average latency: ${AVG_MS} ms"

          {
            echo "lat1=${LAT1}"
            echo "lat2=${LAT2}"
            echo "lat3=${LAT3}"
            echo "avg_ms=${AVG_MS}"
          } >> "$GITHUB_OUTPUT"

      - name: Send Telegram alert
        if: ${{ fromJSON(steps.latency.outputs.avg_ms) > 10000 }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          URL: 'https://ad.new-programmatic.com/services/nslookup?require-debug-info=body&tid=3835&debug.ccg=235034&debug.ip=79.139.162.4'
        run: |
          LAT1=${{ steps.latency.outputs.lat1 }}
          LAT2=${{ steps.latency.outputs.lat2 }}
          LAT3=${{ steps.latency.outputs.lat3 }}
          AVG=${{ steps.latency.outputs.avg_ms }}

          echo "Average too high (${AVG} ms), sending Telegram alert"

          # –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –±–µ–∑ –∫–∞–≤—ã—á–µ–∫ –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
          MSG="üö® Latency Alert!\n"
          MSG+="URL: ${URL}\n"
          MSG+="–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${AVG} ms (> 10000 ms)\n"
          MSG+="–ó–∞–º–µ—Ä—ã:\n"
          MSG+="1) ${LAT1} ms\n"
          MSG+="2) ${LAT2} ms\n"
          MSG+="3) ${LAT3} ms"

          # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –ø–µ—Ä–µ–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è JSON
          MSG_ESCAPED=$(printf '%s' "$MSG" | python -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"text\": ${MSG_ESCAPED}}"

      - name: Log OK
        if: ${{ fromJSON(steps.latency.outputs.avg_ms) <= 10000 }}
        run: |
          echo "‚úÖ Average latency OK: ${{ steps.latency.outputs.avg_ms }} ms"
          echo "Values: ${{ steps.latency.outputs.lat1 }} ms, ${{ steps.latency.outputs.lat2 }} ms, ${{ steps.latency.outputs.lat3 }} ms"
