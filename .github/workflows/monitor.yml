name: Latency Monitor

on:
  schedule:
    - cron: '*/30 * * * *'  # Ð·Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´Ñ‹Ðµ 30 Ð¼Ð¸Ð½ÑƒÑ‚
  workflow_dispatch:      # Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ñ€ÑƒÑ‡Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐ°

jobs:
  monitor:
    runs-on: ubuntu-latest

    steps:
      - name: Measure latency
        id: latency
        env:
          URL: 'https://ad.new-programmatic.com/services/nslookup?require-debug-info=body&tid=3835&debug.ccg=235034&debug.ip=79.139.162.4'
        run: |
          echo "Measuring latency for $URL"

          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ð±Ñ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ… Ð¸ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð¸Ð¼ Ð² Ð¼Ð¸Ð»Ð»Ð¸ÑÐµÐºÑƒÐ½Ð´Ñ‹
          TOTAL_MS=$(curl -o /dev/null -s -w "%{time_total}" "$URL" | awk '{print int($1*1000)}')

          echo "Total latency: ${TOTAL_MS} ms"

          # ÐŸÐ¸ÑˆÐµÐ¼ Ð²Ñ‹Ð²Ð¾Ð´ ÑˆÐ°Ð³Ð° Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… ÑˆÐ°Ð³Ð°Ñ…
          echo "latency_ms=${TOTAL_MS}" >> "$GITHUB_OUTPUT"

      - name: Send Telegram alert
        if: ${{ fromJSON(steps.latency.outputs.latency_ms) > 200 }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          URL: 'https://ad.new-programmatic.com/services/nslookup?require-debug-info=body&tid=3835&debug.ccg=235034&debug.ip=79.139.162.4'
        run: |
          LATENCY=${{ steps.latency.outputs.latency_ms }}
          echo "Latency too high: ${LATENCY} ms, sending Telegram alert"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"text\": \"ðŸš¨ Latency Alert!\nâ±ï¸ Response time: ${LATENCY} ms (>200 ms)\nðŸ”— ${URL}\",
              \"parse_mode\": \"HTML\"
            }"

      - name: Log OK
        if: ${{ fromJSON(steps.latency.outputs.latency_ms) <= 200 }}
        run: |
          echo "âœ… Latency OK: ${{ steps.latency.outputs.latency_ms }} ms"
