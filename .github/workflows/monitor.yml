name: Latency Monitor
on:
  schedule:
    - cron: '*/5 * * * *'  # ÐºÐ°Ð¶Ð´Ñ‹Ðµ 5 Ð¼Ð¸Ð½ÑƒÑ‚
  workflow_dispatch:  # Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
    - name: Measure latency
  id: latency
  env:
    URL: 'https://ad.new-programmatic.com/services/nslookup?require-debug-info=body&tid=3835&debug.ccg=235034&debug.ip=79.139.162.4'
  run: |
    TOTAL_MS=$(curl -o /dev/null -s -w "%{time_total}" "$URL" | awk '{print int($1*1000)}')
    echo "Total latency: $TOTAL_MS ms"
    echo "latency_ms=$TOTAL_MS" >> $GITHUB_OUTPUT

    - name: Send Telegram alert
      if: steps.latency.outputs.latency_ms > 200
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_TOKEN/sendMessage" \
          -H 'Content-Type: application/json' \
          -d "{
            \"chat_id\": \"$TELEGRAM_CHAT_ID\",
            \"text\": \"ðŸš¨ Latency Alert!\nâ±ï¸ Response time: ${{ steps.latency.outputs.latency_ms }}ms (>200ms)\nðŸ”— $URL\",
            \"parse_mode\": \"HTML\"
          }"

    - name: Log success
      if: steps.latency.outputs.latency_ms <= 200
      run: |
        echo "âœ… Latency OK: ${{ steps.latency.outputs.latency_ms }}ms"
